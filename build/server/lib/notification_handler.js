// Generated by CoffeeScript 1.10.0
var NotificationHelper, konnectorHash, localization, log, notification, slugify;

konnectorHash = require('../lib/konnector_hash');

localization = require('../lib/localization_manager');

NotificationHelper = require('cozy-notifications-helper');

notification = new NotificationHelper('konnectors');

slugify = require('cozy-slug');

log = require('printit')({
  prefix: null,
  date: true
});

module.exports = function(konnector, notifContents) {
  var credential, i, index, len, model, notifContent, notificationSlug, prefix, ref, results;
  model = konnectorHash[konnector.slug];
  prefix = localization.t('notification prefix', {
    name: model.name
  });
  results = [];
  for (index in notifContents) {
    notificationSlug = konnector.slug;
    ref = konnector.accounts[index];
    for (i = 0, len = ref.length; i < len; i++) {
      credential = ref[i];
      notificationSlug += "_" + (slugify(credential));
    }
    notifContent = notifContents[index];
    if ((notifContent != null) && typeof notifContent === 'string') {
      results.push(notification.createOrUpdatePersistent(notificationSlug, {
        app: 'konnectors',
        text: prefix + " " + notifContent,
        resource: {
          app: 'konnectors',
          url: "konnector/" + konnector.slug
        }
      }, function(err) {
        if (err != null) {
          return log.error(err);
        }
      }));
    } else {
      results.push(notification.destroy(notificationSlug, function(err) {
        if (err != null) {
          return log.error(err);
        }
      }));
    }
  }
  return results;
};
